name: Deploy to VPS on beta

on:
  push:
    branches: [ beta ]
  # optional: run manually from Actions tab
  workflow_dispatch:

jobs:
  deploy:
    name: SSH to VPS and deploy
    runs-on: ubuntu-latest
    steps:
      - name: Add SSH key (for connecting to VPS)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Trust VPS host
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy
        env:
          APP_DIR: /var/www/trimmers-dev/app            # <- change if your path differs
          REPO_SSH: git@github.com:Mobeen194/Central-Back-End.git
          PM2_TARGET: dev-trimmers-be-5002              # use your PM2 PROCESS NAME (simpler than numeric id)
        run: |
          ssh ${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_HOST }} "
            set -e
            cd $APP_DIR

            # ensure the right remote & branch
            if ! git remote -v | grep -q \"$REPO_SSH\"; then
              git remote set-url origin $REPO_SSH
            fi
            git fetch origin beta
            git checkout beta
            git pull --ff-only origin beta

            # install deps
            npm install   # or: npm ci --omit=dev (recommended if using package-lock.json in prod)

            # restart your PM2 app (by NAME)
            pm2 restart $PM2_TARGET
            pm2 save
          "


